<!doctype html>
<html>
    <head>
        <title>Curso Javascript Completo 2018</title>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <script src="beluga2.js"></script>
        
        
    </head>
    <body>
        <h1>Curso Javascript Completo 2018</h1>      

        <div class="container">
            
        
        <form>
          <div class="form-group">
            <label class="control-label" for="inputCEP">CEP</label>
            <div class="controls">
              <input class="form-control" type="text" id="inputCEP" placeholder="xxxxx-xxx">
            </div>
          </div>
          <div class="form-group">
            <label class="control-label" for="inputLogradouro">Logradouro</label>
            <div class="controls">
              <input class="form-control" type="text" id="inputLogradouro" placeholder="Logradouro">
              <input class="form-control" type="number" id="inputNumero" placeholder="Numero">
            </div>
          </div>
          
          <div class="form-group">
            <label class="control-label" for="inputBairro">Bairro</label>
            <div class="controls">
              <input class="form-control" type="text" id="inputBairro" placeholder="Bairro">
            </div>
          </div>

          <div class="form-group">
            <label class="control-label" for="inputCidade">Cidade</label>
            <div class="controls">
              <input class="form-control" type="text" id="inputCidade" placeholder="Cidade">
            </div>
          </div>
          
          <div class="form-group">
            <label class="control-label" for="inputEstado">Estado</label>
            <div class="controls">
              <input class="form-control" type="text" id="inputEstado" placeholder="Estado">
            </div>
          </div>

          
        </form>
        </div>
    </body>
    
    <script>
        
        let $cep = document.querySelector('#inputCEP');

        $cep.addEventListener('input', function(e){
          let cep = this.value;

          cep = cep.replace('-', '');
          if(cep.length >= 8){
            const promise = obterEndereco(cep);

            promise
            .then( dado => {
              if(dado.erro){
                throw new Error('CEP inexistente');
              }
              mostrarEndereco(dado);
            })
            .catch(err => {
              console.log(err);
            })
          }
          
        })

        async function obterEndereco(cep){
          let url = `https://viacep.com.br/ws/${cep}/json/`;

          const resposta = await fetch(url);

          if(!resposta.ok){
            throw new Error('CEP inválido');
          }

          const json = await resposta.json();

          return json; // é uma promise
        }

        function mostrarEndereco(endereco){
          let $inputLogradouro = document.querySelector('#inputLogradouro');
          let $inputBairro = document.querySelector('#inputBairro')
          let $inputCidade = document.querySelector('#inputCidade')
          let $inputEstado = document.querySelector('#inputEstado');


          $inputLogradouro.value = endereco.logradouro;
          $inputBairro.value = endereco.bairro;
          $inputCidade.value = endereco.localidade;
          $inputEstado.value = endereco.uf;
        }
        

     
        
        
            
    </script>
</html>